exports.new = function(req, res){
    res.render('order_edit', {code:"",errMsg:null,successMsg:null});
};
exports.search= function(req,res,next){     
    var d = domain.create();
    d.on('error', function(err) {
        next(err);
    });
    d.run(function(){
        db.connect(function(){            
            var order={code:req.params.code};
            db.searchOrder(order,function(){
                db.disconnect();
                res.render('order_edit', {code:req.body.code,order:db.orders[0],errMsg:null,successMsg:null});
            });
        }); 
    });
}
exports.add= function(req,res,next){     
    var d = domain.create();
    d.on('error', function(err) {
        next(err);
    });
    d.run(function(){
        db.connect(function(){
            var order=new Object();
            order.code=req.body.code;
            order.date=new Date(req.body.date);
            order.goodsCode=req.body.goodsCode;
            order.brandName=req.body.brandName;
            order.num=req.body.num;
            order.price=req.body.price;
            order.personName=req.body.personName;
            order.email=req.body.email;
            db.addOrder(order,function(){
                db.disconnect();
                if(db.errMsg)
                    res.render('order_edit', {code:req.body.code,order:order,errMsg:db.errMsg,successMsg:null});
                else
                    res.render('order_edit', {code:req.body.code,order:order,errMsg:null,successMsg:null});
            });  
        }); 
    });
}
exports.update= function(req,res,next){     
    var d = domain.create();
    d.on('error', function(err) {
        next(err);
    });
    d.run(function(){
        db.connect(function(){
            var order=new Object();
            order.code=req.body.code;
            order.date=new Date(req.body.date);
            order.goodsCode=req.body.goodsCode;
            order.brandName=req.body.brandName;
            order.num=req.body.num;
            order.price=req.body.price;
            order.personName=req.body.personName;
            order.email=req.body.email;
            db.updateOrder(order,function(){
                db.disconnect();
                res.render('order_edit', {code:req.body.code,order:order,successMsg:'订单数据修改成功。',errMsg:null});
            });  
        }); 
    });
}
exports.delete= function(req,res,next){     
    var d = domain.create();
    d.on('error', function(err) {
        next(err);
    });
    d.run(function(){
        db.connect(function(){
            var order=new Object();
            order.code=req.body.code;
            db.deleteOrder(order,function(){
                db.disconnect();
                if(req.session.code||req.session.date||req.session.goodsCode)
                    res.redirect('/search/');
                else
                    res.render('order_search', {rows:new Array(),order:null})
            });  
        }); 
    });
}
exports.return= function(req,res,next){   
    if(req.session.code||req.session.date||req.session.goodsCode)
        res.redirect('/search/');
    else{
        res.render('order_search', {rows:new Array(),order:null}) 
    } 
}